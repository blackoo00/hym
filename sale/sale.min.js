$(function(){$("#qrcode-wrap").find(".sale-name").attr("style","flex:1");$(document).on("click","#qrcode-wrap .sale-name",function(){document.getElementById("qrcode").click()});$(".sale-show").click(function(){if($(this).hasClass("click-off"))return!1;var a=$(this).siblings(".sale-extend");$(this).addClass("active").parent(".sale-item").siblings().find(".sale-show").removeClass("active");$(".sale-extend").hide();1==a.length&&a.show()});$(document).on("click",".sale-extend p",function(){var a=$(this).data("value"),b=$(this).text();$(this).parents(".sale-extend").hide();var c=$(this).parents(".sale-item").find(".sale-value"),d=$(this).parents(".sale-item").find(".sale-value-input");c.text(b);d.val(a)});$("#submit").click(function(){if(_validate()){var a=_getPostData();$.post(SALE_SUBMIT_URL,a,function(a){200==a.state?$.toast("\u53d1\u5e03\u6210\u529f",function(){window.location=SUCCESS_URL}):$.toast("\u53d1\u5e03\u5931\u8d25","cancel")})}});$(".sale-help").click(function(a){a.stopPropagation();$(this).data("warn")&&$.alert($(this).data("warn"))});$(document).on("change","#qrcode",function(a){var b=$(this).parents(".sale-value").find(".sale-success");a=a.target.files;if(0!==a.length)for(var c=0,d=a.length;c<d;c++){var e=a[c];if(!checkPic(e,a))break;var f=new FileReader;f.onload=function(a){postPic(a.target.result,b)};f.readAsDataURL(e)}});$(document).on("click",".sale-item_add",function(){var a=$(this).parents(".sale-item").clone();a.find(".sale-input").val("");a.find(".sale-show").removeClass("active");a.find(".sale-item_add").removeClass("sale-item_add").addClass("sale-item_del");$("#original-code-list").append(a)});$(document).on("click",".sale-item_del",function(){$(this).parents(".sale-item").remove()})});$("#showDatePicker").on("click",function(){weui.datePicker({start:(new Date).getFullYear(),end:(new Date).getFullYear()+1,defaultValue:[(new Date).getFullYear(),(new Date).getMonth()+1,(new Date).getDate()],onChange:function(a){console.log(a)},onConfirm:function(a){var b=a[0]+"/"+a[1]+"/"+a[2];$("#data-time-show").text(b);$("#datetime").val(b);console.log(a)}})});function canvasPic(a){var b=new Image;b.onload=function(){var a=Math.min(300,b.width),d=a/b.width*b.height,e=document.createElement("canvas"),f=e.getContext("2d");e.width=a;e.height=d;f.drawImage(b,0,0,a,d);e.toDataURL("image/png")};b.src=a.target.result}function showQrcode(a){var b=createCodeCom(a);b.find(".sale-name").text(123);$("#code-list").append(createCodeCom(a));return b}function createCodeCom(a,b,c){var d=$('\x3cdiv class\x3d"sale-item redeen-code"\x3e\n                    \x3cdiv class\x3d"qrcode-show weui_uploader_files"\x3e\n                        \x3cimg class\x3d"qrcode_icon" src\x3d"'+a+'"/\x3e\n                    \x3c/div\x3e\n                    \x3cdiv class\x3d"sale-show"\x3e\n                        \x3cdiv class\x3d"sale-name"\x3e\u5151\u6362\u7801:\x3c/div\x3e\n                        \x3cdiv class\x3d"sale-value"\x3e\n                            \x3cinput class\x3d"sale-input validate form-code" data-qrcode\x3d"" type\x3d"text" value\x3d"" placeholder\x3d"\u8bf7\u8f93\u5165\u5151\u6362\u7801"\x3e\n                            \x3cdiv class\x3d"sale-icon sale-help"\x3e\x3c/div\x3e\n                        \x3c/div\x3e\n                    \x3c/div\x3e\n                \x3c/div\x3e'),e=d.find(".qrcode-show");c&&b?(d.find(".sale-input").val(c),d.find(".sale-input").attr("data-qrcode",b)):(e.addClass("weui-uploader__file_status"),e.append('\x3cdiv class\x3d"weui-icon-warn"\x3e\x3c/div\x3e'));d.on("click",".qrcode-show",function(){createGallery();var b=$("#gallery");b.find(".weui-gallery__img").attr("style","background-image: url("+a+");");b.fadeIn(100);b.find(".weui-gallery__img").click(function(){b.fadeOut(100)});b.find(".weui-icon-delete").click(function(){$.confirm("\u786e\u8ba4\u5220\u9664?",function(){d.remove()});b.fadeOut(100)})});$("#code-list").append(d)}function createGallery(){0==$("#gallery").length&&$(document.body).append('\x3cdiv class\x3d"weui-gallery" style\x3d"display: none" id\x3d"gallery"\x3e\n        \x3cspan class\x3d"weui-gallery__img"\x3e\n        \x3c/span\x3e\n        \x3cdiv class\x3d"weui-gallery__opr"\x3e\n            \x3ca href\x3d"javascript:" class\x3d"weui-gallery__del"\x3e\n                \x3ci class\x3d"weui-icon-delete weui-icon_gallery-delete"\x3e\x3c/i\x3e\n            \x3c/a\x3e\n        \x3c/div\x3e\n    \x3c/div\x3e')}function postPic(a,b){var c=new FormData;c.append("qrcode",convertBase64UrlToBlob(a));$.ajax({url:QRCODE_URL,type:"POST",data:c,dataType:"text",processData:!1,contentType:!1,success:function(d){d=JSON.parse(d);"undefined"!=typeof d.state&&200==d.state?(createCodeCom(a,d.path,d.code),b.show()):createCodeCom(a)},error:function(){createCodeCom(a)},xhr:function(){var a=new XMLHttpRequest;a.upload.addEventListener("progress",function(a){a.lengthComputable&&console.log("\u6b63\u5728\u63d0\u4ea4."+Math.round(100*a.loaded/a.total).toString()+"%")},!1);return a}})}function checkPic(a,b){return-1===["image/jpg","image/jpeg","image/png","image/gif"].indexOf(a.type)?($.alert("\u8be5\u7c7b\u578b\u4e0d\u5141\u8bb8\u4e0a\u4f20"),!1):1048576<b.size?($.alert("\u56fe\u7247\u592a\u5927\uff0c\u4e0d\u5141\u8bb8\u4e0a\u4f20"),!1):2<b.length?($.alert("\u6700\u591a\u53ea\u80fd\u4e0a\u4f202\u5f20\u56fe\u7247"),!1):!0}function convertBase64UrlToBlob(a){a=window.atob(a.split(",")[1]);for(var b=new ArrayBuffer(a.length),c=new Uint8Array(b),d=0;d<a.length;d++)c[d]=a.charCodeAt(d);return new Blob([b],{type:"image/png"})}function _validate(){var a="",b=!0;if(1==$("#datetime").length){var c=$("#datetime").val(),c=new Date(c),c=Date.parse(c),d=new Date,d=Date.parse(d);if(c+864E5<d)return $.alert("\u8f93\u5165\u65f6\u95f4\u5c0f\u4e8e\u5f53\u524d\u65f6\u95f4"),b=!1}$(".validate").each(function(){if(!$(this).val())return a="undefined"==typeof $(this).data("warn")?$(this).attr("placeholder"):$(this).data("warn"),$.alert(a),b=!1});return b}function _getPostData(){var a=$("#sale-form").serialize(),b="",c="";$(".form-code").each(function(){b+=$(this).data("qrcode")+",";c+=$(this).val()+","});b=","==b.substring(b.length-1)?b.substring(0,b.length-1):b;c=","==c.substring(c.length-1)?c.substring(0,c.length-1):c;b&&c&&(a=a+"\x26qrcodes\x3d"+b+"\x26codes\x3d"+c);return a};